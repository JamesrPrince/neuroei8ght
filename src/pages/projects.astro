---
import { createClient } from '@supabase/supabase-js';

const supabase = createClient('https://xcnapnpirhhljynxqgas.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbmFwbnBpcmhobGp5bnhxZ2FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwODgyMzgsImV4cCI6MjA2MTY2NDIzOH0.GUQyYVD3T4AtFFq0A4xD1UG5q5FOb187jCgcZGEgzCY');

async function createProject(event) {
  event.preventDefault();
  const { title, description, budget } = event.target;
  const { error } = await supabase.from('projects').insert({
    title: title.value,
    description: description.value,
    budget: parseFloat(budget.value),
    client_id: supabase.auth.user().id,
  });
  if (error) console.error(error);
}

let searchResults = [];

async function searchProjects(event) {
  event.preventDefault();
  const { keyword, minBudget, maxBudget } = event.target;

  let query = supabase.from('projects').select('*');

  if (keyword.value) {
    query = query.ilike('title', `%${keyword.value}%`).or(`description.ilike.%${keyword.value}%`);
  }

  if (minBudget.value) {
    query = query.gte('budget', parseFloat(minBudget.value));
  }

  if (maxBudget.value) {
    query = query.lte('budget', parseFloat(maxBudget.value));
  }

  const { data, error } = await query;
  if (data) searchResults = data;
  if (error) console.error(error);
}
---

<main class="p-4">
  <h1 class="text-2xl font-bold mb-4">Post a New Project</h1>
  <form onsubmit="createProject">
    <label class="block mb-2">
      Title:
      <input type="text" name="title" class="border p-2 rounded w-full" required />
    </label>
    <label class="block mb-2">
      Description:
      <textarea name="description" class="border p-2 rounded w-full" required></textarea>
    </label>
    <label class="block mb-2">
      Budget:
      <input type="number" name="budget" class="border p-2 rounded w-full" required />
    </label>
    <button type="submit" class="bg-blue-500 text-white p-2 rounded">Post Project</button>
  </form>

  <section class="mt-8">
    <h2 class="text-xl font-bold mb-4">Search Projects</h2>
    <form onsubmit="searchProjects" class="mb-4">
      <label class="block mb-2">
        Keyword:
        <input type="text" name="keyword" class="border p-2 rounded w-full" placeholder="Search by title or description" />
      </label>
      <label class="block mb-2">
        Budget Range:
        <div class="flex gap-2">
          <input type="number" name="minBudget" class="border p-2 rounded w-full" placeholder="Min" />
          <input type="number" name="maxBudget" class="border p-2 rounded w-full" placeholder="Max" />
        </div>
      </label>
      <button type="submit" class="bg-blue-500 text-white p-2 rounded">Search</button>
    </form>

    <h2 class="text-xl font-bold mb-4">Search Results</h2>
    <div>
      {searchResults.map(project => (
        <div class="mb-4 border p-4 rounded">
          <h3 class="text-lg font-bold">{project.title}</h3>
          <p class="text-gray-700">{project.description}</p>
          <p class="text-green-600 font-semibold">Budget: ${project.budget}</p>
        </div>
      ))}
    </div>
  </section>
</main>

<style>
  @media (max-width: 768px) {
    form {
      flex-direction: column;
    }

    input,
    textarea,
    button {
      width: 100%;
      margin-bottom: 1rem;
    }
  }
</style>